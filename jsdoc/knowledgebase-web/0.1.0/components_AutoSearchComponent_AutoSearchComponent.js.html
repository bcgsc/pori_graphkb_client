<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/AutoSearchComponent/AutoSearchComponent.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/AutoSearchComponent/AutoSearchComponent.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/**
 * @module /components/AutoSearchComponent
 */

import React, { Component } from 'react';
import PropTypes from 'prop-types';
import './AutoSearchComponent.css';
import Downshift from 'downshift';
import {
  MenuItem,
  List,
  Paper,
  TextField,
  Typography,
  CircularProgress,
  InputAdornment,
  Popper,
} from '@material-ui/core';
import SearchIcon from '@material-ui/icons/Search';
import * as jc from 'json-cycle';
import _ from 'lodash';
import api from '../../services/api';
import util from '../../services/util';

const DEBOUNCE_TIME = 300;

// More conservative timeout for double query call.
const LONG_DEBOUNCE_TIME = 600;

const PROGRESS_SPINNER_SIZE = 20;
const MAX_HEIGHT_FACTOR = 15;

/**
 * Autocomplete search component for querying ease of use. Text input component
 * that makes small (default limit 30) calls to the api when the user types.
 * Includes a debounce time to prevent large volumes of api calls.
 *
 * Results are displayed in a menu anchored below the input text field,
 * inheriting its width and with a max-height proportional to the specified
 * limit.
 *
 */
class AutoSearchComponent extends Component {
  constructor(props) {
    super(props);
    this.state = {
      options: [],
      emptyFlag: false,
      noRidFlag: false,
      loading: false,
      lastRid: null,
    };
    const { property } = props;
    this.callApi = _.debounce(
      this.callApi.bind(this),
      property.length > 1 ? LONG_DEBOUNCE_TIME : DEBOUNCE_TIME,
    );
    this.refreshOptions = this.refreshOptions.bind(this);
    this.setRef = (node) => { this.popperNode = node; };
  }

  /**
   * Cancels debounce method to avoid memory leaks.
   */
  componentWillUnmount() {
    this.callApi.cancel();
    this.render = null;
  }

  /**
   * Calls api with user input value as parameter.
   * @param {Event} e - user input event.
   */
  refreshOptions(e) {
    this.setState({ loading: true, emptyFlag: false, lastRid: null });
    this.callApi(e.target.value);
  }

  /**
   * Queries the api endpoint specified in the component props. Matches records
   * with the property specified in component props similar to the input value.
   * @param {string} value - value to be sent to the api.
   */
  callApi(value) {
    const {
      limit,
      endpoint,
      property,
    } = this.props;

    api.autoSearch(
      endpoint,
      property,
      value,
      limit,
    ).then((response) => {
      const results = [];
      response.forEach((query) => {
        const cycled = jc.retrocycle(query.result);
        results.push(...cycled);
      });
      const emptyFlag = !!(results.length === 0 &amp;&amp; value);
      this.setState({ options: results, emptyFlag, loading: false });
    }).catch(() => { });
  }

  render() {
    const {
      options,
      emptyFlag,
      noRidFlag,
      lastRid,
      loading,
    } = this.state;

    const {
      children,
      onChange,
      name,
      placeholder,
      value,
      label,
      required,
      disabled,
      endAdornment,
      error,
      dense,
      limit,
    } = this.props;

    const autoSearchResults = (
      inputValue,
      getItemProps,
      setState,
      style,
    ) => options.map((item, index) => children(
      getItemProps,
      item,
      index,
      setState,
      style,
    ));

    return (
      &lt;Downshift
        onChange={(e) => {
          onChange({
            target: {
              value: e.name || e.sourceId,
              sourceId: e.sourceId,
              '@rid': e['@rid'],
              name,
            },
          });
          this.setState({ lastRid: e['@rid'] });
        }}
        itemToString={(item) => {
          if (item) return item.name;
          return null;
        }}
      >
        {({
          getInputProps,
          getItemProps,
          isOpen,
          inputValue,
          setState,
          getMenuProps,
        }) => (
          &lt;div
            className="autosearch-wrapper"
            style={{ minHeight: dense ? '48px' : '64px' }}
          >
            &lt;div ref={this.setRef}>
              &lt;TextField
                fullWidth
                error={emptyFlag || noRidFlag || error}
                label={label}
                required={required}
                InputProps={{
                  ...getInputProps({
                    placeholder,
                    value,
                    onChange,
                    name,
                    disabled,
                    onKeyUp: this.refreshOptions,
                    onFocus: () => this.setState({ noRidFlag: false }),
                    onBlur: () => this.setState({ noRidFlag: !!(!lastRid &amp;&amp; value) }),
                    style: {
                      fontSize: dense ? '0.8125rem' : '',
                    },
                  }),
                  endAdornment: endAdornment ? (
                    &lt;InputAdornment
                      position="end"
                    >
                      {endAdornment}
                    &lt;/InputAdornment>
                  ) : null,
                }}
                style={{
                  fontSize: dense ? '0.8125rem' : '',
                }}
              />
            &lt;/div>
            &lt;Popper
              open={(isOpen || loading) &amp;&amp; !emptyFlag}
              anchorEl={this.popperNode}
              placement="bottom-start"
              {...getMenuProps()}
            >
              &lt;Paper
                className={`droptions ${dense ? 'dense' : ''}`}
                style={{
                  width: this.popperNode
                    ? this.popperNode.clientWidth
                    : null,
                  maxHeight: `${MAX_HEIGHT_FACTOR * limit}px`,
                }}
              >
                &lt;List dense={dense}>
                  {loading
                    ? (
                      &lt;CircularProgress
                        color="primary"
                        size={PROGRESS_SPINNER_SIZE}
                        id="autosearch-spinner"
                      />
                    )
                    : autoSearchResults(inputValue, getItemProps, setState)}
                &lt;/List>
              &lt;/Paper>
            &lt;/Popper>
            {emptyFlag ? ( // Indicator for empty query
              &lt;Typography variant="caption" color="error">
                No Results
              &lt;/Typography>
            ) : null}
            {noRidFlag &amp;&amp; !emptyFlag &amp;&amp; ( // Indicator for unselected option
              &lt;Typography variant="caption" color="error">
                Select an option
              &lt;/Typography>
            )}
          &lt;/div>)
        }
      &lt;/Downshift>
    );
  }
}

AutoSearchComponent.propTypes = {
  /**
   * @param {number} limit - database return record limit.
   */
  limit: PropTypes.number,
  /**
   * @param {string} name - name of input for event parsing.
   */
  name: PropTypes.string.isRequired,
  /**
   * @param {string} endpoint - api endpoint identifier.
   */
  endpoint: PropTypes.string,
  /**
   * @param {string} property - api property identifier.
   */
  property: PropTypes.array,
  /**
   * @param {string} placeholder - placeholder for text input.
   */
  placeholder: PropTypes.string,
  /**
   * @param {string} value - specified value for two way binding.
   */
  value: PropTypes.string,
  /**
   * @param {string} label - label for text input.
   */
  label: PropTypes.string,
  /**
   * @param {bool} required - required flag for text input indicator.
   */
  required: PropTypes.bool,
  /**
   * @param {bool} error - error flag for text input.
   */
  error: PropTypes.bool,
  /**
   * @param {func} onChange - parent method for handling change events
   */
  onChange: PropTypes.func,
  /**
   * @param {function} children - Function that yields the component for
   * display display query results.
   */
  children: PropTypes.func,
  /**
   * @param {bool} disabled - disabled flag for text input.
   */
  disabled: PropTypes.bool,
  /**
   * @param {Object} endAdornment - component to adorn the end of input text field with.
   */
  endAdornment: PropTypes.object,
  /**
   * @param {bool} dense - dense variant flag. If true, font sizes are decreased.
   */
  dense: PropTypes.bool,
};

AutoSearchComponent.defaultProps = {
  limit: 30,
  endpoint: 'ontologies',
  property: ['name'],
  placeholder: '',
  value: '',
  label: '',
  required: false,
  error: false,
  dense: false,
  children: (getItemProps, item, index) => ( // TODO: change this to be more flexible
    &lt;MenuItem
      {...getItemProps({
        key: item['@rid'],
        index,
        item,
      })}
      style={{ whiteSpace: 'normal', height: 'unset' }}
    >
      &lt;span>
        {util.getPreview(item)}
        &lt;Typography color="textSecondary" variant="body1">
          {item.source &amp;&amp; item.source.name ? item.source.name : ''}
        &lt;/Typography>
      &lt;/span>
    &lt;/MenuItem>
  ),
  onChange: null,
  disabled: false,
  endAdornment: &lt;SearchIcon />,
};

export default AutoSearchComponent;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-_App.html">/App</a></li><li><a href="module-_components_AutoSearchComponent.html">/components/AutoSearchComponent</a></li><li><a href="module-_components_DownloadFileComponent.html">/components/DownloadFileComponent</a></li><li><a href="module-_components_GraphActionsNode.html">/components/GraphActionsNode</a></li><li><a href="module-_components_GraphComponent.html">/components/GraphComponent</a></li><li><a href="module-_components_GraphLink.html">/components/GraphLink</a></li><li><a href="module-_components_GraphNode.html">/components/GraphNode</a></li><li><a href="module-_components_NodeDetailComponent.html">/components/NodeDetailComponent</a></li><li><a href="module-_components_NodeFormComponent.html">/components/NodeFormComponent</a></li><li><a href="module-_components_ResourceSelectComponent.html">/components/ResourceSelectComponent</a></li><li><a href="module-_components_TableComponent.html">/components/TableComponent</a></li><li><a href="module-_services_api.html">/services/api</a></li><li><a href="module-_services_auth.html">/services/auth</a></li><li><a href="module-_services_util.html">/services/util</a></li><li><a href="module-_views_AddNodeView.html">/views/AddNodeView</a></li><li><a href="module-_views_AdvancedQueryView.html">/views/AdvancedQueryView</a></li><li><a href="module-_views_DataView.html">/views/DataView</a></li><li><a href="module-_views_EditNodeView.html">/views/EditNodeView</a></li><li><a href="module-_views_ErrorView.html">/views/ErrorView</a></li><li><a href="module-_views_FeedbackView.html">/views/FeedbackView</a></li><li><a href="module-_views_LoginView.html">/views/LoginView</a></li><li><a href="module-_views_NodeDetailView.html">/views/NodeDetailView</a></li><li><a href="module-_views_QueryView.html">/views/QueryView</a></li><li><a href="module-services_history.html">services/history</a></li></ul><h3>Classes</h3><ul><li><a href="module-_App-App.html">App</a></li><li><a href="module-_components_AutoSearchComponent-AutoSearchComponent.html">AutoSearchComponent</a></li><li><a href="module-_components_GraphComponent-GraphComponent.html">GraphComponent</a></li><li><a href="module-_components_GraphNode-GraphNode.html">GraphNode</a></li><li><a href="module-_components_NodeDetailComponent-NodeDetailComponent.html">NodeDetailComponent</a></li><li><a href="module-_components_NodeFormComponent-NodeFormComponent.html">NodeFormComponent</a></li><li><a href="module-_components_TableComponent-TableComponent.html">TableComponent</a></li><li><a href="module-_views_AddNodeView-AddNodeView.html">AddNodeView</a></li><li><a href="module-_views_AdvancedQueryView-AdvancedQueryView.html">AdvancedQueryView</a></li><li><a href="module-_views_DataView-DataView.html">DataView</a></li><li><a href="module-_views_EditNodeView-EditNodeView.html">EditNodeView</a></li><li><a href="module-_views_ErrorView-ErrorView.html">ErrorView</a></li><li><a href="module-_views_LoginView-LoginView.html">LoginView</a></li><li><a href="module-_views_NodeDetailView-NodeDetailView.html">NodeDetailView</a></li><li><a href="module-_views_QueryView-QueryView.html">QueryView</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Aug 17 2018 13:28:05 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
