<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: views/DataView/DataView.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: views/DataView/DataView.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module /views/DataView
 */

import React, { Component } from 'react';
import PropTypes from 'prop-types';
import './DataView.css';
import * as jc from 'json-cycle';
import { Route, Redirect, Switch } from 'react-router-dom';
import {
  CircularProgress,
  Drawer,
  IconButton,
  Snackbar,
  Button,
  Typography,
} from '@material-ui/core';
import CloseIcon from '@material-ui/icons/Close';
import { withStyles } from '@material-ui/core/styles';
import qs from 'qs';
import GraphComponent from '../../components/GraphComponent/GraphComponent';
import TableComponent from '../../components/TableComponent/TableComponent';
import NodeDetailComponent from '../../components/NodeDetailComponent/NodeDetailComponent';
import api from '../../services/api';

const styles = {
  paper: {
    width: '500px',
    '@media (max-width: 768px)': { width: 'calc(100% - 1px)' },
  },
};

const DEFAULT_LIMIT = 1000;

/**
 * View for managing state of query results. Contains sub-routes for table view (/data/table)
 * and graph view (/data/graph) to display data. Redirects to /data/table for all other
 * sub-routes.
 *
 * Handles all api calls for its child components, including firing the passed in query
 * from the url search string, retrieving the database schema, and making subsequent
 * individual record GETs throughout the user's session.
 *
 */
class DataView extends Component {
  constructor(props) {
    super(props);
    this.state = {
      loginRedirect: false,
      data: null,
      displayed: [],
      hidden: [],
      selectedId: null,
      allProps: [],
      detail: null,
      next: null,
      completedNext: true,
      filteredSearch: null,
    };

    this.handleClick = this.handleClick.bind(this);

    // TableComponent methods
    this.handleCheckbox = this.handleCheckbox.bind(this);
    this.handleCheckAll = this.handleCheckAll.bind(this);
    this.handleHideSelected = this.handleHideSelected.bind(this);
    this.handleShowAllNodes = this.handleShowAllNodes.bind(this);
    this.handleSubsequentPagination = this.handleSubsequentPagination.bind(this);

    // GraphComponent methods
    this.handleDetailDrawerOpen = this.handleDetailDrawerOpen.bind(this);
    this.handleDetailDrawerClose = this.handleDetailDrawerClose.bind(this);
    this.handleNewColumns = this.handleNewColumns.bind(this);

    // NodeDetailComponent methods
    this.handleNodeEditStart = this.handleNodeEditStart.bind(this);
    this.handleNewQuery = this.handleNewQuery.bind(this);

    // Routing methods
    this.handleGraphRedirect = this.handleGraphRedirect.bind(this);
    this.handleTableRedirect = this.handleTableRedirect.bind(this);
  }

  /**
   * Queries the api and loads results into component state.
   */
  async componentDidMount() {
    const dataMap = {};
    const { loginRedirect } = this.state;
    const { history } = this.props;

    const schema = await api.getSchema();
    const filteredSearch = qs.parse(history.location.search);
    let route = '/ontologies';

    if (filteredSearch['@class'] &amp;&amp; schema[filteredSearch['@class']]) {
      route = schema[filteredSearch['@class']].route || filteredSearch['@class'];
    }

    let allProps = ['@rid', '@class'];
    try {
      const data = await api.get(`${route}?${qs.stringify(filteredSearch).slice(3)}&amp;neighbors=3`);
      const cycled = jc.retrocycle(data.result);

      cycled.forEach((ontologyTerm) => {
        allProps = api.collectOntologyProps(ontologyTerm, allProps, schema);
        dataMap[ontologyTerm['@rid']] = ontologyTerm;
      });

      if (cycled.length >= filteredSearch.limit || DEFAULT_LIMIT) {
        const nextFilteredSearch = Object.assign({}, filteredSearch);
        nextFilteredSearch.skip = filteredSearch.limit || DEFAULT_LIMIT;
        this.setState({
          next: () => api.get(`${route}?${qs.stringify(nextFilteredSearch).slice(3)}&amp;neighbors=3`),
          moreResults: true,
        });
      }
      this.setState({
        data: dataMap,
        selectedId: Object.keys(dataMap)[0],
        loginRedirect,
        allProps,
        schema,
        filteredSearch,
        edges: api.getEdges(schema),
      });
    } catch (e) {
      console.error(e);
    }
  }

  /**
   * Triggered function for when a node object is clicked in a child component.
   * Sets the state selected ID to clicked node.
   * @param {string} rid - Clicked node identifier.
   */
  async handleClick(rid) {
    const { data } = this.state;
    if (!data[rid]) {
      const endpoint = `/ontologies/${rid.slice(1)}?neighbors=3`;
      const json = await api.get(endpoint);
      data[rid] = jc.retrocycle(json.result);
      this.setState({ data });
    }
    this.setState({ selectedId: rid });
  }

  /**
   * Adds node identifier to list of displayed nodes.
   * @param {string} rid - Checked node identifier.
   */
  handleCheckbox(rid) {
    const { displayed } = this.state;
    const i = displayed.indexOf(rid);
    if (i === -1) {
      displayed.push(rid);
    } else {
      displayed.splice(i, 1);
    }
    this.setState({ displayed });
  }

  /**
   * Adds all data entries to the list of displayed nodes.
   * @param {Event} e - Checkbox event.
   */
  handleCheckAll(e, pageData) {
    let displayed;
    if (e.target.checked) {
      displayed = pageData.map(d => d['@rid']);
    } else {
      displayed = [];
    }
    this.setState({ displayed });
  }

  /**
   * Clears displayed array.
   */
  handleHideSelected() {
    const { displayed, hidden, selectedId } = this.state;
    hidden.push(...displayed);

    if (displayed.includes(selectedId)) this.setState({ selectedId: null });

    this.setState({ hidden, displayed: [] });
  }

  /**
   * Appends the input array to the displayed array.
   */
  handleShowAllNodes() {
    const { displayed, hidden } = this.state;

    displayed.push(...hidden);
    this.setState({ displayed, hidden: [] });
  }

  /**
   * Handles subsequent pagination call
   */
  handleSubsequentPagination() {
    const { next } = this.state;

    if (next) {
      next().then((nextData) => {
        const {
          data,
          allProps,
          schema,
          filteredSearch,
        } = this.state;
        const cycled = jc.retrocycle(nextData.result);
        let newColumns = allProps;
        cycled.forEach((ontologyTerm) => {
          newColumns = api.collectOntologyProps(ontologyTerm, allProps, schema);
          data[ontologyTerm['@rid']] = ontologyTerm;
        });

        let route = '/ontologies';
        if (filteredSearch['@class']) {
          route = schema[filteredSearch['@class']].route;
        }

        let newNext = null;
        let moreResults = false;
        if (cycled.length >= (filteredSearch.limit || DEFAULT_LIMIT)) {
          const newSkip = Number(filteredSearch.skip)
            + Number((filteredSearch.limit || DEFAULT_LIMIT));
          filteredSearch.skip = newSkip;
          newNext = () => api.get(`${route}?${qs.encode(filteredSearch)}&amp;neighbors=3`);
          moreResults = true;
        }
        this.setState({
          data,
          allProps: newColumns,
          next: newNext,
          filteredSearch,
          moreResults,
          completedNext: true,
        });
      });
    }
    this.setState({ next: null, moreResults: false, completedNext: false });
    return next;
  }

  /**
   * Sets selected ID to input node identifier and opens edit drawer.
   * @param {string} rid - Target node rid.
   */
  handleNodeEditStart(rid) {
    const { data } = this.state;
    const { history } = this.props;
    history.push({
      pathname: `/edit/${rid.slice(1)}`,
      state: {
        node: data[rid],
      },
    });
  }

  /**
   * Re initializes the component and loads a new query into the search.
   * @param {string} search - new search string
   */
  handleNewQuery(search) {
    const { history } = this.props;
    const { location } = history;

    if (location.search.split('?')[1] !== search) {
      history.push(`/data/table?${search}`);
      this.setState({
        loginRedirect: false,
        data: null,
        displayed: [],
        hidden: [],
        selectedId: null,
        allProps: [],
      }, this.componentDidMount);
    }
  }

  /**
   * Closes detail drawer.
   */
  handleDetailDrawerClose() {
    this.setState({ detail: null });
  }

  /**
   * Updates data and opens detail drawer for the specified node.
   * @param {Object} node - Specified node.
   * @param {boolean} open - flag to open drawer, or to just update.
   * @param {boolean} edge - flag to indicate edge record.
   */
  async handleDetailDrawerOpen(node, open, edge) {
    const { data, detail } = this.state;
    if (!open &amp;&amp; !detail) return;
    if (edge) {
      this.setState({ detail: node.data, detailEdge: true });
    } else {
      if (!data[node.data['@rid']]) {
        const response = await api.get(`/ontologies/${node.data['@rid'].slice(1)}?neighbors=3`);
        data[node.data['@rid']] = jc.retrocycle(response.result);
      }
      this.setState({ detail: data[node.data['@rid']], detailEdge: false });
    }
  }

  /**
   * Handles redirect to graph from table.
   */
  handleGraphRedirect() {
    const { history } = this.props;
    history.push({ pathname: '/data/graph', search: history.location.search });
  }

  /**
   * Handles redirect to table from graph.
   */
  handleTableRedirect() {
    const { history } = this.props;
    this.setState({ detail: null });
    history.push({
      pathname: '/data/table',
      search: history.location.search,
    });
  }

  /**
   * Updates column list with field keys from new node.
   * @param {Object} node - newly added object.
   */
  handleNewColumns(node) {
    const { allProps, schema } = this.state;
    this.setState({ allProps: api.collectOntologyProps(node, allProps, schema) });
  }

  render() {
    const {
      selectedId,
      data,
      displayed,
      hidden,
      allProps,
      detail,
      schema,
      moreResults,
      filteredSearch,
      edges,
      detailEdge,
      completedNext,
    } = this.state;

    const {
      classes,
      history,
    } = this.props;

    if (!data) return &lt;CircularProgress color="secondary" size={100} id="progress-spinner" />;

    const detailDrawer = (
      &lt;Drawer
        variant="persistent"
        anchor="right"
        open={!!detail}
        classes={{
          paper: classes.paper,
        }}
        onClose={this.handleDetailDrawerClose}
        SlideProps={{ unmountOnExit: true }}
      >
        &lt;NodeDetailComponent
          variant="graph"
          node={detail}
          handleNodeEditStart={this.handleNodeEditStart}
          handleNewQuery={this.handleNewQuery}
          handleClose={this.handleDetailDrawerClose}
          detailEdge={detailEdge}
        >
          &lt;IconButton onClick={this.handleDetailDrawerClose}>
            &lt;CloseIcon color="action" />
          &lt;/IconButton>
        &lt;/NodeDetailComponent>
      &lt;/Drawer>
    );

    const GraphWithProps = () => (
      &lt;GraphComponent
        data={data}
        handleClick={this.handleClick}
        displayed={displayed}
        handleNodeEditStart={this.handleNodeEditStart}
        handleDetailDrawerOpen={this.handleDetailDrawerOpen}
        handleDetailDrawerClose={this.handleDetailDrawerClose}
        handleTableRedirect={this.handleTableRedirect}
        schema={schema}
        edges={edges}
        detail={detail}
        allProps={allProps}
        filteredSearch={filteredSearch}
        handleNewColumns={this.handleNewColumns}
      />
    );
    const TableWithProps = () => (
      &lt;TableComponent
        data={data}
        selectedId={selectedId}
        handleClick={this.handleClick}
        handleCheckbox={this.handleCheckbox}
        displayed={displayed}
        hidden={hidden}
        allProps={allProps}
        moreResults={moreResults}
        completedNext={completedNext}
        handleCheckAll={this.handleCheckAll}
        handleNodeEditStart={this.handleNodeEditStart}
        handleHideSelected={this.handleHideSelected}
        handleShowAllNodes={this.handleShowAllNodes}
        handleNewQuery={this.handleNewQuery}
        handleGraphRedirect={this.handleGraphRedirect}
        handleSubsequentPagination={this.handleSubsequentPagination}
      />
    );
    return (
      &lt;div className="data-view">
        &lt;Snackbar
          anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
          open={Object.keys(data).length === 0}
          onClose={() => history.push('/query')}
          autoHideDuration={3000}
          message={(
            &lt;span>
              No results found, redirecting...
            &lt;/span>
          )}
          action={(
            &lt;Button color="secondary" onClick={() => history.push('/query')}>
              Ok
            &lt;/Button>
          )}
        />
        {detailDrawer}
        {Object.keys(data).length !== 0
          ? (
            &lt;Switch>
              &lt;Route exact path="/data/table" render={TableWithProps} />
              &lt;Route exact path="/data/graph" render={GraphWithProps} />
              &lt;Route exact path="/data/*">
                {
                  &lt;Redirect to={`/data/table${history.location.search}`} />
                }
              &lt;/Route>
            &lt;/Switch>
          ) : (
            &lt;div className="no-results-msg">
              &lt;Typography variant="headline">
                No Results
              &lt;/Typography>
            &lt;/div>
          )
        }
      &lt;/div>);
  }
}

DataView.propTypes = {
  /**
   * @param {Object} history - Application routing history object.
   */
  history: PropTypes.object.isRequired,
  /**
   * @param {Object} classes - Classes provided by the @material-ui withStyles function
   */
  classes: PropTypes.object.isRequired,
};

export default withStyles(styles)(DataView);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-_App.html">/App</a></li><li><a href="module-_components_AutoSearchComponent.html">/components/AutoSearchComponent</a></li><li><a href="module-_components_DownloadFileComponent.html">/components/DownloadFileComponent</a></li><li><a href="module-_components_GraphActionsNode.html">/components/GraphActionsNode</a></li><li><a href="module-_components_GraphComponent.html">/components/GraphComponent</a></li><li><a href="module-_components_GraphLink.html">/components/GraphLink</a></li><li><a href="module-_components_GraphNode.html">/components/GraphNode</a></li><li><a href="module-_components_NodeDetailComponent.html">/components/NodeDetailComponent</a></li><li><a href="module-_components_NodeFormComponent.html">/components/NodeFormComponent</a></li><li><a href="module-_components_ResourceSelectComponent.html">/components/ResourceSelectComponent</a></li><li><a href="module-_components_TableComponent.html">/components/TableComponent</a></li><li><a href="module-_services_api.html">/services/api</a></li><li><a href="module-_services_auth.html">/services/auth</a></li><li><a href="module-_services_util.html">/services/util</a></li><li><a href="module-_views_AddNodeView.html">/views/AddNodeView</a></li><li><a href="module-_views_AdvancedQueryView.html">/views/AdvancedQueryView</a></li><li><a href="module-_views_DataView.html">/views/DataView</a></li><li><a href="module-_views_EditNodeView.html">/views/EditNodeView</a></li><li><a href="module-_views_ErrorView.html">/views/ErrorView</a></li><li><a href="module-_views_FeedbackView.html">/views/FeedbackView</a></li><li><a href="module-_views_LoginView.html">/views/LoginView</a></li><li><a href="module-_views_NodeDetailView.html">/views/NodeDetailView</a></li><li><a href="module-_views_QueryView.html">/views/QueryView</a></li><li><a href="module-services_history.html">services/history</a></li></ul><h3>Classes</h3><ul><li><a href="module-_App-App.html">App</a></li><li><a href="module-_components_AutoSearchComponent-AutoSearchComponent.html">AutoSearchComponent</a></li><li><a href="module-_components_GraphComponent-GraphComponent.html">GraphComponent</a></li><li><a href="module-_components_GraphNode-GraphNode.html">GraphNode</a></li><li><a href="module-_components_NodeDetailComponent-NodeDetailComponent.html">NodeDetailComponent</a></li><li><a href="module-_components_NodeFormComponent-NodeFormComponent.html">NodeFormComponent</a></li><li><a href="module-_components_TableComponent-TableComponent.html">TableComponent</a></li><li><a href="module-_views_AddNodeView-AddNodeView.html">AddNodeView</a></li><li><a href="module-_views_AdvancedQueryView-AdvancedQueryView.html">AdvancedQueryView</a></li><li><a href="module-_views_DataView-DataView.html">DataView</a></li><li><a href="module-_views_EditNodeView-EditNodeView.html">EditNodeView</a></li><li><a href="module-_views_ErrorView-ErrorView.html">ErrorView</a></li><li><a href="module-_views_LoginView-LoginView.html">LoginView</a></li><li><a href="module-_views_NodeDetailView-NodeDetailView.html">NodeDetailView</a></li><li><a href="module-_views_QueryView-QueryView.html">QueryView</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Aug 17 2018 13:28:05 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
